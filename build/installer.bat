@echo off & setlocal EnableDelayedExpansion
title Release Automatic Packing
set path=%cd%
set/p version=Please enter the version: 
if exist installer.nsi del installer.nsi
if exist EmailBuilder_%version%_Release.exe del EmailBuilder_%version%_Release.exe


echo ; Script generated by the HM NIS Edit Script Wizard. >> installer.nsi

echo. >> installer.nsi

echo ; HM NIS Edit Wizard helper defines >> installer.nsi
echo ^^!define PRODUCT_NAME "EmailBuilder" >> installer.nsi
echo ^^!define PRODUCT_VERSION "%version%" >> installer.nsi
echo ^^!define PRODUCT_PUBLISHER "ZORANNER" >> installer.nsi
echo ^^!define PRODUCT_WEB_SITE "https://zoran.ink" >> installer.nsi
echo ^^!define PRODUCT_DIR_REGKEY "Software\Microsoft\Windows\CurrentVersion\App Paths\EmailBuilder.exe" >> installer.nsi
echo ^^!define PRODUCT_UNINST_KEY "Software\Microsoft\Windows\CurrentVersion\Uninstall\${PRODUCT_NAME}" >> installer.nsi
echo ^^!define PRODUCT_UNINST_ROOT_KEY "HKLM" >> installer.nsi

echo. >> installer.nsi

echo ; MUI 1.67 compatible ------ >> installer.nsi
echo ^^!include "MUI.nsh" >> installer.nsi
echo ^^!include "WordFunc.nsh" >> installer.nsi

echo. >> installer.nsi

echo ; MUI Settings >> installer.nsi
echo ^^!define MUI_ABORTWARNING >> installer.nsi
echo ^^!define MUI_ICON "%path%\EmailBuilder\Resources\Pictures\e-mail-256.ico" >> installer.nsi
echo ^^!define MUI_UNICON "%path%\EmailBuilder\Resources\Pictures\e-mail-256.ico" >> installer.nsi

echo. >> installer.nsi

echo ; Welcome page >> installer.nsi
echo ^^!insertmacro MUI_PAGE_WELCOME >> installer.nsi

echo ; License page >> installer.nsi
echo ^^!insertmacro MUI_PAGE_LICENSE "%path%\License" >> installer.nsi

echo ; Directory page >> installer.nsi
echo ^^!insertmacro MUI_PAGE_DIRECTORY >> installer.nsi

echo ; Instfiles page >> installer.nsi
echo ^^!insertmacro MUI_PAGE_INSTFILES >> installer.nsi

echo ; Finish page >> installer.nsi
echo ^^!define MUI_FINISHPAGE_RUN "$INSTDIR\EmailBuilder.exe" >> installer.nsi
echo ^^!insertmacro MUI_PAGE_FINISH >> installer.nsi

echo. >> installer.nsi

echo ; Uninstaller pages >> installer.nsi
echo ^^!insertmacro MUI_UNPAGE_INSTFILES >> installer.nsi

echo. >> installer.nsi

echo ; Language files >> installer.nsi
echo ^^!insertmacro MUI_LANGUAGE "SimpChinese" >> installer.nsi

echo. >> installer.nsi
echo ; MUI end ------ >> installer.nsi

echo. >> installer.nsi

echo Name "${PRODUCT_NAME} ${PRODUCT_VERSION}" >> installer.nsi
echo OutFile "%path%\installers\EmailBuilder_${PRODUCT_VERSION}_Release.exe" >> installer.nsi
echo InstallDir "$PROGRAMFILES\Zoranner\EmailBuilder" >> installer.nsi
echo InstallDirRegKey HKLM "${PRODUCT_DIR_REGKEY}" "" >> installer.nsi
echo ShowInstDetails show >> installer.nsi
echo ShowUnInstDetails show >> installer.nsi
echo BrandingText "ZORANNER" >> installer.nsi

echo. >> installer.nsi

echo Section "主程序" SEC01 >> installer.nsi
echo   SetDetailsPrint textonly >> installer.nsi
echo   DetailPrint "正在安装系统主程序..." >> installer.nsi
echo   SetDetailsPrint listonly >> installer.nsi
echo   SetOverwrite try >> installer.nsi

echo   SetOutPath "$INSTDIR" >> installer.nsi
for /f "delims=" %%j in ('"dir EmailBuilder\bin\x86\Release\ /b/a:-d"') do (
    echo %path%\EmailBuilder\bin\x86\Release\%%j
    nsistrb "  File" %path%\EmailBuilder\bin\x86\Release\ "%%j" >> installer.nsi
)

for /f "delims=" %%i in ('"dir EmailBuilder\bin\x86\Release /s/b/a:d"') do (
    echo %%i
    nsistrb "  SetOutPath" "%%i" %path%\EmailBuilder\bin\x86\Release $INSTDIR >> installer.nsi
    for /f "delims=" %%j in ('"dir %%i /b/a:-d"') do (
        echo %%i\%%j
        nsistrb "  File" "%%i"\ "%%j" >> installer.nsi
    )
)

echo   CreateDirectory "$SMPROGRAMS\Zoranner" >> installer.nsi
echo   CreateShortCut "$SMPROGRAMS\Zoranner\EmailBuilder.lnk" "$INSTDIR\EmailBuilder.exe" >> installer.nsi
echo   CreateShortCut "$DESKTOP\EmailBuilder.lnk" "$INSTDIR\EmailBuilder.exe" >> installer.nsi

echo SectionEnd >> installer.nsi

echo. >> installer.nsi

echo Section -AdditionalIcons >> installer.nsi
echo   ;WriteIniStr "$INSTDIR\${PRODUCT_NAME}.url" "InternetShortcut" "URL" "${PRODUCT_WEB_SITE}" >> installer.nsi
echo   CreateShortCut "$SMPROGRAMS\Zoranner\Uninstall.lnk" "$INSTDIR\Uninstall.exe" >> installer.nsi
echo SectionEnd >> installer.nsi

echo. >> installer.nsi

echo Section -Post >> installer.nsi
echo   WriteUninstaller "$INSTDIR\Uninstall.exe" >> installer.nsi
echo   WriteRegStr HKLM "${PRODUCT_DIR_REGKEY}" "" "$INSTDIR\EmailBuilder.exe" >> installer.nsi
echo   WriteRegStr ${PRODUCT_UNINST_ROOT_KEY} "${PRODUCT_UNINST_KEY}" "DisplayName" "${PRODUCT_NAME}" >> installer.nsi
echo   WriteRegStr ${PRODUCT_UNINST_ROOT_KEY} "${PRODUCT_UNINST_KEY}" "UninstallString" "$INSTDIR\Uninstall.exe" >> installer.nsi
echo   WriteRegStr ${PRODUCT_UNINST_ROOT_KEY} "${PRODUCT_UNINST_KEY}" "DisplayIcon" "$INSTDIR\EmailBuilder.exe" >> installer.nsi
echo   WriteRegStr ${PRODUCT_UNINST_ROOT_KEY} "${PRODUCT_UNINST_KEY}" "DisplayVersion" "${PRODUCT_VERSION}" >> installer.nsi
echo   WriteRegStr ${PRODUCT_UNINST_ROOT_KEY} "${PRODUCT_UNINST_KEY}" "URLInfoAbout" "${PRODUCT_WEB_SITE}" >> installer.nsi
echo   WriteRegStr ${PRODUCT_UNINST_ROOT_KEY} "${PRODUCT_UNINST_KEY}" "Publisher" "${PRODUCT_PUBLISHER}" >> installer.nsi
echo SectionEnd >> installer.nsi

echo. >> installer.nsi

echo Function un.onUninstSuccess >> installer.nsi
echo   HideWindow >> installer.nsi
echo   MessageBox MB_ICONINFORMATION^|MB_OK "${PRODUCT_NAME} 已成功地从你的计算机移除。" >> installer.nsi
echo FunctionEnd >> installer.nsi

echo. >> installer.nsi

echo Function un.onInit >> installer.nsi
echo   MessageBox MB_ICONQUESTION^|MB_YESNO^|MB_DEFBUTTON2 "你确实要完全移除 ${PRODUCT_NAME} ，其及所有的组件？" IDYES +2 >> installer.nsi
echo   Abort >> installer.nsi
echo FunctionEnd >> installer.nsi

echo. >> installer.nsi

echo Section Uninstall >> installer.nsi
echo   ;Delete "$INSTDIR\${PRODUCT_NAME}.url" >> installer.nsi
echo   Delete "$INSTDIR\Uninstall.exe" >> installer.nsi

for /f "delims=" %%i in ('"dir EmailBuilder\bin\x86\Release /s/b/a:-d"') do (
    rem echo %%i
    nsistrb "  Delete" "%%i" %path%\EmailBuilder\bin\x86\Release $INSTDIR >> installer.nsi
)

echo. >> installer.nsi

echo   Delete "$SMPROGRAMS\Zoranner\Uninstall.lnk" >> installer.nsi
echo   Delete "$SMPROGRAMS\Zoranner\EmailBuilder.lnk" >> installer.nsi
echo   Delete "$DESKTOP\EmailBuilder.lnk" >> installer.nsi

echo. >> installer.nsi

echo   RMDir "$SMPROGRAMS\Zoranner" >> installer.nsi

echo   RMDir "$INSTDIR\" >> installer.nsi

echo. >> installer.nsi

echo   DeleteRegKey ${PRODUCT_UNINST_ROOT_KEY} "${PRODUCT_UNINST_KEY}" >> installer.nsi
echo   DeleteRegKey HKLM "${PRODUCT_DIR_REGKEY}" >> installer.nsi
echo   SetAutoClose true >> installer.nsi
echo SectionEnd >> installer.nsi

"C:\Program Files (x86)\NSIS\makensis.exe" installer.nsi

@echo.
set /p="Press any key to exit..."<nul
pause>nul